---
output:
  word_document: 
    reference_docx: Template_KORA.docx
    
editor_options: 
  chunk_output_type: console
  
params:
  effective.TN: NULL
  potentially.TN: NULL
  Title: NULL
  Language: NULL
  Authors: NULL
  KORAphoto: NULL
  Lynxmaster: NULL
  PhotoPredator: NULL
  LynxObs: NULL
  Compartment: NULL
  Refarea: NULL
  favorable: NULL
  Period.selected: NULL
  JuvasMother: NULL
  Species.other: NULL
  which.best.model.selected: NULL
---


```{r Manual Data Information, echo=FALSE}

# ------ !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! ------ #
#     All the information which is not automatically computed, should be added here.           #     
#               This is done with the function KORAtool::KORAMonitoringBericht                 #
# ------ !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! ------ #

  #Trap night calendar information:

  effective.TN = params$effective.TN 
  potentially.TN= params$potentially.TN 
  #Title:
  Title= params$Title 
  Language= params$Language 
  #Authors: ex."Luc Le Grand, Florin Kunz, Fridolin Zimmermann"
  Authors= params$Authors
  #KORAphoto data csv name:
  KORAphoto= params$KORAphoto
  #Lynx master data csv name:
  Lynxmaster= params$Lynxmaster
  #Photo Predator csv name:
  PhotoPredator= params$PhotoPredator
  #Lynx Observation CSV name:
  LynxObs=params$LynxObs
  #Compartment: 
  #1:"Nordostschweiz"
  #2:"Misox (Mesolcina)"
  #3:"Tessin"
  #4:"Surselva"
  #5:"Zentralschweiz Ost"
  #6:"Rhone-Nord"
  #7:"Unterwallisüd"
  #8:"Simme-Saane"
  #9:"Engadin"
  #10:"Jura Nord"
  #11:"Jura Süd"
  #12:"Mittelbünden"
  #13:"Zentralschweiz West"
  #14:"Zentralschweiz Mitte"
  #15:"Berner Oberland Ost"
  #16:"Oberwallis")
  Compartment= params$Compartment
  #Sutdy Area (Reference Area):
  # 1: "Western central Switzerland"
  # 2: "North-eastern Switzerland"  
  # 3: "North-western Alps"
  # 4: "Mid-central Switzerland"
  # 5: "Southern Jura"
  # 6: "Central Jura"
  # 7: "Northern Jura" 
  # 8: "Northern Valais"  
  Refarea = params$Refarea
  #Suitable habitat (km2):
  favorable= params$favorable
  #Period length selected (3 other 5 days)
  Period.selected= params$Period.selected
  #JuvasMother
  JuvasMother= params$JuvasMother
  #Species.other to be ploted at the end of the report
  Species.other = params$Species.other
  # Which best Model (1 to 8)
  which.best.model.selected = params$which.best.model.selected

```

```{r R Packages, include=FALSE}
devtools::install_github("CrocutaLupus/KORAtool")
library(KORAtool)


library(data.table)
library(knitr)#tables
library(pander)
library(flextable)



# ------ Projection : ####
#Projection to be used for the map (CH1903 / LV03):
#Warnings OK
suppressWarnings(CRS<- sp::CRS("+init=epsg:21781"))


```

```{r Import data, include=FALSE}

##### Import all the raw data needed ####

#KORA photo data:
Data<-data.table::fread(KORAphoto)
Data$TIME<-as.POSIXct(paste(Data$exposure_date,Data$exposure_time ,sep=" "), format= '%Y-%m-%d %H:%M:%S')

#Lynx master data table:
L.master<-data.table::fread(Lynxmaster)
L.master$mother<-as.character(L.master$mother)
L.master$yearOfBirth<-as.numeric(L.master$yearOfBirth)

#Text table for thanking part and method's foot note:
Text.table<-read.csv("Det_Mon_Report_Data_per_Reference_Area.csv")


##### Data Handling: ####

#Select Juveniles's year of birth (previous year):
juv.year<-data.table::year(max(Data$TIME))-1

```

```{r Table sites information, echo=FALSE}
#Table all sites:
Table.Sites<-data.table::data.table(SiteName=sort(unique(Data[,site_name])),
                                    Npictures=0,
                                    Npicutreslynx=0)


for(i in 1:length(Table.Sites$SiteName)){
  
  Table.Sites[i,"Npictures"]<-length(Data[Data$site_name==Table.Sites[i,SiteName],file_name])
  Table.Sites[i,"Npicutreslynx"]<-length(Data[Data$site_name==Table.Sites[i,SiteName] &
                                                Data$animal_species=="Lynx lynx",file_name])
}

     
Table.Sites$RunningNumber<-1:length(Table.Sites$SiteName)

Table.Sites<-flextable(Table.Sites)
Table.Sites <- set_caption(Table.Sites, caption = " Summary Sites Session. Please control in KORA photo that each site has at least one picture of something.")
Table.Sites<-font(Table.Sites,fontname = "Calibri", part = "all")
Table.Sites<-fontsize(Table.Sites,size = 12, part = "body")
Table.Sites<- autofit(Table.Sites) 
Table.Sites<-height_all(Table.Sites, height = .26)
Table.Sites<- hrule(Table.Sites, rule = "exact")

```

```{r abstract number automatic, echo=FALSE}

Start<-as.POSIXct(paste(Data[1,session_study_start_date],
                          Data[1,session_study_start_time],sep=" "),
                    format= '%Y-%m-%d %H:%M:%S')
  
Stop<-as.POSIXct(paste(Data[1,session_study_end_date],
                         Data[1,session_study_end_time],sep=" "),
                   format= '%Y-%m-%d %H:%M:%S')

Sites<-length(unique(Data$site_name))

#Count Lynx
Lynx.Table<-data.table::data.table(ID=unique(Data[Data$animal_species=="Lynx lynx" &
                                   Data$id_individual!="U",id_individual]))


for(i in 1:length(Lynx.Table$ID)){
  Lynx.Table[i,"YOB"]<-L.master[L.master$name==Lynx.Table$ID[i],yearOfBirth]
  Lynx.Table[i,"Sex"]<-L.master[L.master$name==Lynx.Table$ID[i],sex]
  Lynx.Table[i,"mother"]<-L.master[L.master$name==Lynx.Table$ID[i],mother]
  Lynx.Table[i,"Flank"]<-L.master[L.master$name==Lynx.Table$ID[i],chipNo]
}
Lynx.Table$Flank<-as.character(Lynx.Table$Flank)
Lynx.Table[!is.na(Lynx.Table$Flank),"Flank"]<-"B"
Lynx.Table[grepl("B",Lynx.Table$ID) & is.na(Lynx.Table$Flank),"Flank"]<-"B"
Lynx.Table[grepl("R",Lynx.Table$ID) & is.na(Lynx.Table$Flank),"Flank"]<-"R"
Lynx.Table[grepl("L",Lynx.Table$ID) & is.na(Lynx.Table$Flank),"Flank"]<-"L"

Lynx.Table.Adult<-Lynx.Table[Lynx.Table$YOB!=juv.year | is.na(Lynx.Table$YOB),]

N.ind.lynx<-length(Lynx.Table.Adult[Lynx.Table.Adult$Flank=="B",ID])+
            max(length(Lynx.Table.Adult[Lynx.Table.Adult$Flank=="L",ID]),
                length(Lynx.Table.Adult[Lynx.Table.Adult$Flank=="R",ID]))

N.juv<-length(Lynx.Table[Lynx.Table$YOB==juv.year & Lynx.Table$Flank=="B",ID])+
            max(length(Lynx.Table[Lynx.Table$YOB==juv.year & Lynx.Table$Flank=="R",ID]),
                length(Lynx.Table[Lynx.Table$YOB==juv.year & Lynx.Table$Flank=="L",ID]))

#Event:

## create column with ID of captured Individual, juvenile catches count as catch of the mother
Data$ID.mummy<-Data$id_individual

for(i in 1:length(Lynx.Table[Lynx.Table$YOB==juv.year,ID])){
  if(Lynx.Table[Lynx.Table$ID==Lynx.Table[Lynx.Table$YOB==juv.year,ID][i],mother]!=""){
    Data[Data$id_individual==Lynx.Table[Lynx.Table$YOB==juv.year,ID][i],"ID.mummy"]<-Lynx.Table[Lynx.Table$ID==Lynx.Table[Lynx.Table$YOB==juv.year,ID][i],mother]
  } #mother not known
}


#Select if Juveniles are counted as mother or not
if(JuvasMother==TRUE){
  Data$ID<-Data$ID.mummy
}
if(JuvasMother==FALSE){
  Data$ID<-Data$id_individual
}

# Create Event Table
Event<-KORAtool::EvCountR(Table_Object=Data[!grepl(paste("U",paste(Lynx.Table[Lynx.Table$YOB==juv.year,ID],collapse="|"),sep="|"),
                                         Data$ID) & Data$animal_species=="Lynx lynx",],Event_length=30)


Data$Sex<-""

for(i in 1:length(Lynx.Table$ID)){
  
  Data[Data$id_individual==Lynx.Table[i,ID],"Sex"]<-Lynx.Table[i,Sex]
  
}

Data[Data$Sex=="","Sex"]<-NA


```

```{r Main Map, echo = FALSE}
KORAtool::KORAmapsex(KORA.Photo.Output=Data,
  species="Lynx lynx",
  Buffer.map=0.03,
  Zoom.map=10,
  IDremove="U",
  Start=Start,
  Stop=Stop,
  Pattern="T",#pattern not resent but used not to block the function
  Buffer.label=2000,
  Name.Map="Map_Report",
  Refarea=Refarea,
  Red.point.ID="U")
```

```{r Lynx Table, echo=FALSE}



Event.report<-Event

Event.report<-merge(x = Event.report, y = Lynx.Table, by="ID", all.x = TRUE)
Event.report$Flank<-NULL
Event.report$YOB<-as.character(Event.report$YOB)

Event.report[Event.report$Sex=="unknown","Sex"]<-NA
Event.report[Event.report$Sex=="male","Sex"]<-"M"
Event.report[Event.report$Sex=="female","Sex"]<-"F"

# --- Add first seen

#Import Raw Data (CSV from KORA Data): 
  LynxMaster.table<-suppressWarnings(data.table::fread(Lynxmaster))
  LynxObs.table<-data.table::fread(LynxObs,select=c("lynx_ID","image_uid","date"))
  PhotoPredator.table<-data.table::fread(PhotoPredator,select=c("id_individual","exposure_date","session_name"))
#Select interesting Columns:  
  First.seen.table<-LynxMaster.table[,c("name","coatPattern","yearOfBirth","deathDate","mother")]

#Fill in info First/Last seen: 
 for(i in 1:length(First.seen.table$name)){
   First.seen.table[i,"FirstSeen"]<-suppressWarnings(min(min(as.POSIXct(LynxObs.table[LynxObs.table$lynx_ID==as.character(First.seen.table[i,name]),date],format='%Y-%m-%d',tz="")),
                                   min(as.POSIXct(PhotoPredator.table[PhotoPredator.table$id_individual==as.character(First.seen.table[i,name]),exposure_date],format='%Y-%m-%d'))))
   First.seen.table[i,"LastSeen"]<- suppressWarnings(max(max(as.POSIXct(LynxObs.table[LynxObs.table$lynx_ID==as.character(First.seen.table[i,name]),date],format='%Y-%m-%d',tz="")),
                                   max(as.POSIXct(PhotoPredator.table[PhotoPredator.table$id_individual==as.character(First.seen.table[i,name]),exposure_date],format='%Y-%m-%d'))))
}

Event.report<-merge(Event.report, First.seen.table[,c("name","FirstSeen")],all.x = TRUE,by.x = "ID",by.y = "name")

Event.report$FirstSeen<-as.character(year(Event.report$FirstSeen))

# --- Add juveniles info to each known mother
for(i in 1:length(unique(Lynx.Table[Lynx.Table$YOB==juv.year,mother]))){
  Event.report[Event.report$ID==unique(Lynx.Table[Lynx.Table$YOB==juv.year,mother])[i],"Juv"]<-paste(
    Lynx.Table[Lynx.Table$mother==unique(Lynx.Table[Lynx.Table$YOB==juv.year,mother])[i] & !is.na(Lynx.Table$mother),ID],collapse=", ")
}

#Rename Table
Event.report<-Event.report[,c("ID","Event","N pictures","N site","YOB","FirstSeen","Sex","mother","Juv")]

names(Event.report)<-c("ID","Événement","N photo","N site","Naissance","Connu","Sexe","Mère","Juvénile")

#Total as last:
bindtotal<-Event.report[Event.report$ID=="Total",]
Event.report<-Event.report[Event.report$ID!="Total",]
Event.report<-rbind(Event.report,bindtotal)


# Data table into flextable to plot:

Event.report<-flextable(Event.report)
Event.report <- set_caption(Event.report, caption = " Lynx détectés dans le cadre du monitoring du lynx dans l’aire de référence pendant les 60 nuits d’échantillonnage. Un évenement comprend toutes les images  à un site donné séparées de moins de 30 minutes. Le nombre total de sites où un lynx a été observé est plus petit que la somme des sites, car certains sites sont les mêmes.")

# --- Add footnote:

#Texte juvéniles sans mère:
txt.juv<-"Juvénile sans mère connue: "

if(length(Lynx.Table[Lynx.Table$YOB==juv.year & Lynx.Table$mother=="",ID])>0){
 for(i in 1:length(Lynx.Table[Lynx.Table$YOB==juv.year & Lynx.Table$mother=="",ID])){
  
 txt.juv<- paste(txt.juv,
    Lynx.Table[Lynx.Table$YOB==juv.year & Lynx.Table$mother=="",ID][i]," (N photo = ",
      length(Data[Data$id_individual==Lynx.Table[Lynx.Table$YOB==juv.year & Lynx.Table$mother=="",ID][i],file_name]),
    ") ",sep="")

  } 
}else{
  
txt.juv<-"Tous les juvéniles photographiés ont pu être associé à leur mère."

}

#Text JuvasMother:


if(JuvasMother==TRUE){
  
txt.juvasmother<-"Dû à leur fort taux de disparition (mortalité et dispersion) les individus juvéniles photographiés au cours du monitoring sont identifiés et considérés comme une capture de leur mère. Si la mère est connu, ils sont indiqués à la colonne juvénile." 
  
}else{
  
txt.juvasmother<-"Dû à leur fort taux de disparition (mortalité et dispersion) les individus juvéniles photographiés au cours du monitoring sont identifiés, mais pas considérés. Si la mère est connu, ils sont indiqués à la colonne juvénile."

}



#Create footnote:
Event.report<- footnote( Event.report, i = 1,j=c(1,2,3),
            value = as_paragraph(
                      c(txt.juv,
                        txt.juvasmother,
                        "N photo: Si plusieurs individus sont pris sur une même photo, cette photo est comptée le même nombre de fois qu'il y a d'individu.")),
            ref_symbols = c("1","2","3"),
            part = "header")


Event.report<-font(Event.report,fontname = "Calibri", part = "all")
Event.report<-fontsize(Event.report,size = 12, part = "body")

Event.report<- autofit(Event.report) 
Event.report<-height_all(Event.report, height = .26)
Event.report<- hrule(Event.report, rule = "exact")

```

```{r Opp Mon Map, echo=FALSE}

# KORAmapopp

Plot.Opp.Mon<-KORAtool::KORAmapopp(LynxObs= LynxObs,
                              Start=Start,
                              Stop=Stop,
                              Compartment=Compartment,
                              Refarea=Refarea,
                              IDremove=c("U","lx","XXXX"),
                              Buffer.polygon=2000)

ggplot2::ggsave("Plot_Opp_Mon.jpeg",plot=Plot.Opp.Mon,
                    units = "cm",
                    width = 16.5,
                    height = 16.5)



# -- Plot function Monitoring Opp

Plot_KORA_Report<-function(Species){
  # ------ Projection : 
  #Projection to be used for the map (CH1903 / LV03):
  #Warnings OK
  suppressWarnings(CRS<- sp::CRS("+init=epsg:21781"))
  
  #Import shapefile compartment
  Komp <- sf::read_sf(dsn = "MAP_Data/Luchs_Komp_21_07_2015_new.shp")
  
  # -- Study Area 

  study_area<-sp::bbox(as.matrix(Komp$geometry[Compartment][[1]]))
  
  study_area<-rgeos::readWKT(paste("POLYGON((",
                                   study_area[1,1]," ",study_area[2,1],",",
                                   study_area[1,1]," ",study_area[2,2],",",
                                   study_area[1,2]," ",study_area[2,2],",",
                                   study_area[1,2]," ",study_area[2,1],",",
                                   study_area[1,1]," ",study_area[2,1],"))",sep=""),p4s= CRS)

  
  # -- Altitude layer #
  Alt <- raster::raster("MAP_Data/CHHS.TIF")
  
  # indicate CRS
  raster::crs(Alt) <- CRS 

  # crop 
  Alt<-raster::crop(Alt,study_area)

  # convert to a df for plotting in two steps:
  # First, to a SpatialPointsDataFrame
  Alt_pts <- raster::rasterToPoints(Alt, spatial = TRUE)
  # Then to a 'conventional' dataframe
  Alt_df  <- data.frame(Alt_pts)
  rm(Alt_pts, Alt)

  # -- Import shapefile lakes
  suppressWarnings(Lakes <- raster::shapefile("MAP_Data/grandlacs.shp"))
  Lakes<-raster::crop(Lakes,study_area)
  Lakes<-sf::st_as_sf(Lakes)

  # --- Import shapefile Study area Polygon
  suppressWarnings(Rcompartment <- raster::shapefile("MAP_Data/Reference_areas_alln.shp"))
  Rcompartment<-Rcompartment[Refarea,]
  Rcompartment<-sf::st_as_sf(Rcompartment)
  
  map<-ggplot2::ggplot() +
  #Alt Raster
  ggplot2::geom_raster(data = Alt_df , ggplot2::aes(x = x, y = y, alpha = CHHS))+
  ggplot2::scale_alpha(name = "", range = c(0.6, 0))+
  #Polygon Compartment
  ggplot2::geom_sf(data=Komp$geometry[Compartment],fill="white", alpha = 0.4)+
  #Lakes
  ggplot2::geom_sf(data=Lakes,fill="#56B4E9")+
  #Reference Area
  ggplot2::geom_sf(data=Rcompartment,col="#009E73",fill=NA,lwd=1.1)

  
  #Add Sites
  map<-map+ggplot2::geom_point(data=Data,ggplot2::aes(x,y), col="white", pch=19,cex=2)+
      ggplot2::geom_point(data=Data,ggplot2::aes(x,y),col="black", pch=1,cex=2)
  
    
    
  #Points Sites with Species
  map<-map+ggplot2::geom_point(data=Data[Data$animal_species==Species & 
                                  Data$TIME>=Start &
                                  Data$TIME<=Stop,],
                               ggplot2::aes(x=x,y=y),
                               col="black", pch=19, cex=1.5)
  
  
  #Theme
  map<-map+ggplot2::theme(plot.title =ggplot2::element_blank(),
        strip.background = ggplot2::element_blank(),
        panel.background= ggplot2::element_rect(fill = "white",color="black"),
        panel.grid = ggplot2::element_line(colour = "white"),
        axis.title =ggplot2::element_blank(),
        axis.text = ggplot2::element_blank(),
        axis.ticks= ggplot2::element_blank(),
        legend.position="none",
        panel.border = ggplot2::element_rect(colour = "black", fill=NA, size=1.5),
        plot.caption = ggplot2::element_text(hjust = 0, face= "italic"))+
        ggplot2::labs(caption=Species)
  
  print(map)
  
}

```

```{r Occasion Tables, echo=FALSE}
# Create table occasion:
Occ.table<-data.table(ID=unique(Lynx.Table.Adult$ID))


# To carry the analyses of the lynx monitoring, we test periods of 3 days and periods of 5 days

for(Period in c(3,5)){
  
# ---- Create Empty Occurrence Matrix  
occasions<-seq(from = Start,to = Stop, by = paste(Period,"days", sep=" "))
Occ.table<-data.table::data.table(ID = unique(Lynx.Table.Adult$ID))
if(Period==3){
  Occ.table[,c(as.character(occasions[-21])):= 0]
}
if(Period==5){
  Occ.table[,c(as.character(occasions[-13])):= 0]
}

# ---- Fill in Matrix (observation of juvenile counts as an observation of the mother)
for(i in 1:length(Occ.table$ID)){
  for(j in 2:ncol(Occ.table)){
    Data_loop<- Data[Data$TIME > as.POSIXct(names(Occ.table)[j])  &
                         Data$TIME < as.POSIXct(names(Occ.table)[j]) + Period*86400 & #select days occasion
                         Data$ID.mummy == Occ.table[i,ID],c("TIME","file_name")]
    if(length(Data_loop$file_name)!=0){
      Occ.table[i,j]<-1
    }else{Occ.table[i,j]<-0}
  }
}

# ---- Check if an individual has no single catch within the study period (60nights)
for(i in 1:length(Occ.table$ID)){
  if(sum(Occ.table[1,2:ncol(Occ.table)])==0){
    warning("warning: ID has not been seen during the 60 days.")
  }
}


# ---- Occ.table for Plot cumulative (2 table, one per period length)

if(Period==3){
Occ.table.3<-Occ.table
Occ.table.plot.3<-dcast(melt(Occ.table, id.vars = "ID"), variable ~ ID)
names(Occ.table.plot.3)[1]<-"TIME"
#number of captures per occasion
Occ.table.plot.3$SUM.occasion<-rowSums(Occ.table.plot.3[,-1])
#cumulative number of captures per occasion
Occ.table.plot.3$SUM.occasion.cumulative<-cumsum(Occ.table.plot.3$SUM.occasion)

#Cumulative number of ID lynx

Occ.table.plot.3$SUM.ID.cumulative<-sum(Occ.table.plot.3[1,2:(length(Occ.table.plot.3)-2)])
Sum.ID<-as.numeric(Occ.table.plot.3[1,2:(length(Occ.table.plot.3)-3)])

for(i in 2:20){
 Sum.ID<-Sum.ID+as.numeric(Occ.table.plot.3[i,2:(length(Occ.table.plot.3)-3)])

 Sum.ID<-replace(Sum.ID, Sum.ID==2, 1)
 
 Occ.table.plot.3[i,"SUM.ID.cumulative"]<-sum(Sum.ID)
  
}

}

if(Period==5){
Occ.table.5<-Occ.table
Occ.table.plot.5<-dcast(melt(Occ.table, id.vars = "ID"), variable ~ ID)
names(Occ.table.plot.5)[1]<-"TIME"
#number of captures per occasion
Occ.table.plot.5$SUM.occasion<-rowSums(Occ.table.plot.5[,-1])
#cumulative number of captures per occasion
Occ.table.plot.5$SUM.occasion.cumulative<-cumsum(Occ.table.plot.5$SUM.occasion)

#Cumulative number of ID lynx

Occ.table.plot.5$SUM.ID.cumulative<-sum(Occ.table.plot.5[1,2:(length(Occ.table.plot.5)-2)])
Sum.ID<-as.numeric(Occ.table.plot.5[1,2:(length(Occ.table.plot.5)-3)])

for(i in 2:12){
 Sum.ID<-Sum.ID+as.numeric(Occ.table.plot.5[i,2:(length(Occ.table.plot.5)-3)])

 Sum.ID<-replace(Sum.ID, Sum.ID==2, 1)
 
 Occ.table.plot.5[i,"SUM.ID.cumulative"]<-sum(Sum.ID)
  
}

}

}

```

```{r closure analyses, echo=FALSE}

# ---- Closed Test:

for(Period in c(3,5)){
  
#Create table Sites info + read trap
Lynx_trapXY<-unique(Data[,c("site_name","x","y")])
names(Lynx_trapXY)[1]<-"trapID"
traps.lynx <- secr::read.traps(data = Lynx_trapXY)

#Create table observation info
Lynx_captXY<-data.table(Session=1,
                        ID=rep(Lynx.Table.Adult$ID,each=(60/Period)*length(Lynx_trapXY$trapID)),
                        Occasion=rep(rep(1:(60/Period),each=length(Lynx_trapXY$trapID)),length(Lynx.Table.Adult$ID)),
                        X=rep(Lynx_trapXY$x),
                        X=rep(Lynx_trapXY$y),
                        TrapID=rep(Lynx_trapXY$trapID),
                        Seen="NO")

if(Period==3){
  occasions<-seq(from = Start,to = Stop, by = paste(Period,"days", sep=" "))
  occasions<-occasions[-21]
  
  #Fill in information if lynx seen during period at given site
  for(i in 1:length(Lynx_captXY$Session)){
  Data_loop<- Data[Data$TIME > as.POSIXct(occasions[Lynx_captXY[i,Occasion]])  &
                         Data$TIME < as.POSIXct(occasions[Lynx_captXY[i,Occasion]]) + Period*86400 & #select days occasion
                         Data$ID.mummy == Lynx_captXY[i,ID] &
                         Data$site_name== Lynx_captXY[i,TrapID],c("TIME","file_name")]
  
  if(length(Data_loop$file_name)>0){
    Lynx_captXY[i,"Seen"]<-"YES"
  }
  }
  
}
if(Period==5){
  
  #Occasions starting data/time
  occasions<-seq(from = Start,to = Stop, by = paste(Period,"days", sep=" "))
  occasions<-occasions[-13]
  
  #Fill in information if lynx seen during period at given site
  for(i in 1:length(Lynx_captXY$Session)){
  Data_loop<- Data[Data$TIME > as.POSIXct(occasions[Lynx_captXY[i,Occasion]])  &
                         Data$TIME < as.POSIXct(occasions[Lynx_captXY[i,Occasion]]) + Period*86400 & #select days occasion
                         Data$ID.mummy == Lynx_captXY[i,ID] &
                         Data$site_name== Lynx_captXY[i,TrapID],c("TIME","file_name")]
  
  if(length(Data_loop$file_name)>0){
    Lynx_captXY[i,"Seen"]<-"YES"
  }
  }
  
  
}



Lynx_captXY<-Lynx_captXY[Lynx_captXY$Seen=="YES",-c("TrapID","Seen")]

# --- Closure Test

if(Period==3){
  # ---- Create capthist 
  suppressWarnings(Lynx.CHxy.3  <- secr::make.capthist (Lynx_captXY, traps.lynx, fmt = "XY"))
  #warnings OK it produces the same results as in the program
  
  # ---- Closure test
  suppressWarnings(closure.result.3<-secr::closure.test(Lynx.CHxy.3,SB=TRUE))
  #warnings if pop too small
  
  # ---- Output for Mark program
  
  #Empty table
  inp.Mark<-data.table::data.table(ID=Lynx.Table.Adult$ID,ch="empty")
  #needs data.frame
  Occ.table.plot.3.1<-as.data.frame(Occ.table.plot.3)
  for(i in 1:length(Lynx.Table.Adult$ID)){
    inp.Mark[i,"ch"]<-paste( Occ.table.plot.3.1[,inp.Mark$ID[i]] ,collapse = "")
  }
  #process (RMark format)
  inp.Mark=RMark::process.data(inp.Mark)
  #output
  RMark::export.chdata(data=inp.Mark, filename=paste(ReportName,"period_3",sep="_"), covariates = NULL, replace = TRUE)
  
}

if(Period==5){
  # ---- Create capthist  
  suppressWarnings(Lynx.CHxy.5  <- secr::make.capthist (Lynx_captXY, traps.lynx, fmt = "XY"))
  #warnings OK it produces the same results as in the program
  
  # ---- Closure test
  suppressWarnings(closure.result.5<-secr::closure.test(Lynx.CHxy.5,SB=TRUE))
  #warnings if pop too small - do it any way like in program
  
  # ---- Output for Mark program
  
  #Empty table
  inp.Mark<-data.table::data.table(ID=Lynx.Table.Adult$ID,ch="empty")
  #needs data.frame
  Occ.table.plot.5.1<-as.data.frame(Occ.table.plot.5)
  for(i in 1:length(Lynx.Table.Adult$ID)){
    inp.Mark[i,"ch"]<-paste( Occ.table.plot.5.1[,inp.Mark$ID[i]] ,collapse = "")
  }
  #process (RMark format)
  inp.Mark=RMark::process.data(inp.Mark)
  #output
  RMark::export.chdata(data=inp.Mark, filename=paste(ReportName,"period_5",sep="_"), covariates = NULL, replace = TRUE)
}

}

```

```{r SECR analyses, echo= FALSE, message=FALSE, results='hide', warning=FALSE}

# ----------------------------- !!!!!----------------------------------------- #
# It is assumed that MARK.EXE is located in directory "C:/Program Files/Mark". #
# https://cran.r-project.org/web/packages/RMark/RMark.pdf                      #
# ----------------------------- !!!!!----------------------------------------- #



#Capture History Period=3:
CaptHist.table.3<-data.table(ID=Occ.table.3$ID)
for( i in 1:length(Occ.table.3$ID)){
CaptHist.table.3[i,"ch"]<-paste(as.numeric(Occ.table.3[i,2:length(Occ.table.3)]),collapse = "")
}

#Capture History Period=5:
CaptHist.table.5<-data.table(ID=Occ.table.5$ID)
for( i in 1:length(Occ.table.5$ID)){
CaptHist.table.5[i,"ch"]<-paste(as.numeric(Occ.table.5[i,2:length(Occ.table.5)]),collapse = "")
}

#R MArk Analzses function
lynx.Mark.models=function(CaptHist.table)
{
  #
  # Define parameter models
  #
  pdotshared=list(formula=~1,share=TRUE)
  ptimeshared=list(formula=~time,share=TRUE)
  pmixture=list(formula=~mixture)
  #
  # Run assortment of models
  #
  #
  # Capture Closed models
  #
  # M0: constant p=c
  Lynx.m0=RMark::mark(CaptHist.table,model="Closed",
                    model.parameters=list(p=pdotshared))

  # Mt: Variation accross occasions. time varying p=c
  Lynx.mt=RMark::mark(CaptHist.table,model="Closed",
                    model.parameters=list(p=ptimeshared))
  # Mh: Variation among individuals
  Lynx.Mh=RMark::mark(CaptHist.table,model="HetClosed",
                     model.parameters=list(p=pmixture))
  
  # Return model table and list of models
  #
  return(RMark::collect.models() )
}


# fit models in mark by calling function created above
# warnings ok

#suppressWarnings(Lynx.Mark.results.3<-lynx.Mark.models(CaptHist.table.3))
#suppressWarnings(Lynx.Mark.results.5<-lynx.Mark.models(CaptHist.table.5))


#Select best model:
# Create Mark Table:
Mark.Table<-data.table(Period=rep(c(3,5),each=4),
                       Model=c("M0","Mb","Mt","Mh"),
                       AIC=0,
                       N=0,
                       Min=0,
                       Max=0)


# Add AICc from RMARK to MArk.Table 
#(to get same value as in Mark programm, unadjusted for Mt and Mh, ex. Lynx.Mark.results.3$Lynx.Mh$results$AICc.unadjusted)
#Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="M0","AICc"]<-round(Lynx.Mark.results.3$Lynx.m0$results$AICc,2)
#Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mt","AICc"]<-round(Lynx.Mark.results.3$Lynx.mt$results$AICc,2)
#Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mh","AICc"]<-round(Lynx.Mark.results.3$Lynx.Mh$results$AICc,2)

#Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="M0","AICc"]<-round(Lynx.Mark.results.5$Lynx.m0$results$AICc,2)
#Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mt","AICc"]<-round(Lynx.Mark.results.5$Lynx.mt$results$AICc,2)
#Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mh","AICc"]<-round(Lynx.Mark.results.5$Lynx.Mh$results$AICc,2)

# Estimation N lynx
closedN.3<-secr::closedN(Lynx.CHxy.3, estimator = c("null","zippin","darroch","betabinomial"),
                       level = 0.95, maxN = 1e+07, dmax = 10 )

closedN.5<-secr::closedN(Lynx.CHxy.5, estimator = c("null","zippin","darroch","betabinomial"),
                       level = 0.95, maxN = 1e+07, dmax = 10 )



# Add info in Mark.Table Period = 3
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="M0","AIC"]<-round(closedN.3$AIC[1],2)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mb","AIC"]<-round(closedN.3$AIC[2],2)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mt","AIC"]<-round(closedN.3$AIC[3],2)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mh","AIC"]<-round(closedN.3$AIC[4],2)

Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="M0","N"]<-round(closedN.3$Nhat[1],0)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mb","N"]<-round(closedN.3$Nhat[2],0)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mt","N"]<-round(closedN.3$Nhat[3],0)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mh","N"]<-round(closedN.3$Nhat[4],0)

Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="M0","SE"]<-round(closedN.3$seNhat[1],2)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mb","SE"]<-round(closedN.3$seNhat[2],2)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mt","SE"]<-round(closedN.3$seNhat[3],2)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mh","SE"]<-round(closedN.3$seNhat[4],2)

Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="M0","Min"]<-round(closedN.3$lclNhat[1],0)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mb","Min"]<-round(closedN.3$lclNhat[2],0)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mt","Min"]<-round(closedN.3$lclNhat[3],0)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mh","Min"]<-round(closedN.3$lclNhat[4],0)

Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="M0","Max"]<-round(closedN.3$uclNhat[1],0)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mb","Max"]<-round(closedN.3$uclNhat[2],0)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mt","Max"]<-round(closedN.3$uclNhat[3],0)
Mark.Table[Mark.Table$Period==3 & Mark.Table$Model=="Mh","Max"]<-round(closedN.3$uclNhat[4],0)

# Add info in Mark.Table Period = 5
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="M0","AIC"]<-round(closedN.5$AIC[1],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mb","AIC"]<-round(closedN.5$AIC[2],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mt","AIC"]<-round(closedN.5$AIC[3],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mh","AIC"]<-round(closedN.5$AIC[4],0)

Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="M0","N"]<-round(closedN.5$Nhat[1],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mb","N"]<-round(closedN.5$Nhat[2],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mt","N"]<-round(closedN.5$Nhat[3],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mh","N"]<-round(closedN.5$Nhat[4],0)

Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="M0","SE"]<-round(closedN.5$seNhat[1],2)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mb","SE"]<-round(closedN.5$seNhat[2],2)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mt","SE"]<-round(closedN.5$seNhat[3],2)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mh","SE"]<-round(closedN.5$seNhat[4],2)

Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="M0","Min"]<-round(closedN.5$lclNhat[1],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mb","Min"]<-round(closedN.5$lclNhat[2],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mt","Min"]<-round(closedN.5$lclNhat[3],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mh","Min"]<-round(closedN.5$lclNhat[4],0)

Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="M0","Max"]<-round(closedN.5$uclNhat[1],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mb","Max"]<-round(closedN.5$uclNhat[2],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mt","Max"]<-round(closedN.5$uclNhat[3],0)
Mark.Table[Mark.Table$Period==5 & Mark.Table$Model=="Mh","Max"]<-round(closedN.5$uclNhat[4],0)

# IC in one column:
Mark.Table$IC<-paste(Mark.Table$Min,Mark.Table$Max,sep="-")
Mark.Table$Min<-NULL
Mark.Table$Max<-NULL

#Order by AIC and period
Mark.Table.3<-Mark.Table[Mark.Table$Period==3,]
Mark.Table.3<-Mark.Table.3[order(Mark.Table.3$AIC),]

Mark.Table.5<-Mark.Table[Mark.Table$Period==5,]
Mark.Table.5<-Mark.Table.5[order(Mark.Table.5$AIC),]

Mark.Table<-rbind(Mark.Table.3,Mark.Table.5)

#Make a copy to have shorter code in inline code (for abstract):
Mark.Table.inline<-Mark.Table

#Mark.Table as a felxtable
Mark.Table<-flextable(Mark.Table)
Mark.Table <- set_caption(Mark.Table, caption = " Sélection du meilleur modèle et estimation du nombre de lynx.")
Mark.Table<-font(Mark.Table,fontname = "Calibri", part = "all")
Mark.Table<-fontsize(Mark.Table,size = 12, part = "body")


#In Bold the Best model (lower AIC in period category)
which.best.model.3<-which(Mark.Table$body$dataset$AIC== min(Mark.Table$body$dataset[Mark.Table$body$dataset$Period==3,"AIC"]))
which.best.model.5<-which(Mark.Table$body$dataset$AIC== min(Mark.Table$body$dataset[Mark.Table$body$dataset$Period==5,"AIC"]))

Mark.Table <- bold(Mark.Table, bold = TRUE, i=c(which.best.model.3,which.best.model.5))


#Change name to fit language
Mark.Table <- set_header_labels(Mark.Table,
                        values = list(Period = "Période",
                                      Model = "Modèle",
                                      AICc = "AIC",
                                      N = "N lynx",
                                      IC = "IC 95%"))

#Create footnote:

if(Language=="FR"){
 Mark.Table<- footnote( Mark.Table, i =1 ,j=2,part = "header",
            value = as_paragraph("M0: P. are constant
Mb: P. vary by behavioural response to capture
Mt: P. vary with time
Mh: P. vary by individual animal"),ref_symbols = c(""))

}

#Autofit (last to make sur it works)
Mark.Table<-autofit(Mark.Table)
Mark.Table<-height_all(Mark.Table, height = .26)
Mark.Table<- hrule(Mark.Table, rule = "exact")
Mark.Table<- hline(Mark.Table, i=4)

```

```{r table Opp. mon,echo=FALSE}

# Import Lynx Observation Data
Data.opp<-data.table::fread(LynxObs,select=(c("lynx_ID","date","type","x","y","canton","SCALP","fk_case_id")))
Data.opp$date<-as.POSIXct(Data.opp$date,  format= '%Y-%m-%d' )
  
#Subset data Session window
Data.opp<-Data.opp[Data.opp$date>Start & Data.opp$date<Stop,]
  
#Observations as spatial points
pts <- sf::st_as_sf(Data.opp, coords = c("x","y"))
pts <-sf::st_set_crs(pts, 21781) 
  
#Import shapefile reference area
Refareashp <- sf::read_sf(dsn = "MAP_Data/Reference_areas_alln.shp")
  
#Subset observation within the reference area
#Warnings ok
suppressWarnings(pts<-sf::st_intersection(pts,Refareashp$geometry[Refarea]))
  

#Sort data Opp. Mon.
pts<-as.data.table(pts)
pts<-pts[,c("fk_case_id","date","type","lynx_ID","canton","SCALP")]

Opp.table<-data.table(ID=sort(unique(pts$lynx_ID)))

if(length(Opp.table$ID)>0){
  for(i in 1:length(Opp.table$ID)){
    Opp.table[i,"Event"]<-length(unique(pts[pts$lynx_ID==Opp.table[i,ID],fk_case_id]))
    Opp.table[i,"Min.date"]<-min(pts[pts$lynx_ID==Opp.table[i,ID],date])
    Opp.table[i,"Max.date"]<-max(pts[pts$lynx_ID==Opp.table[i,ID],date])
    Opp.table[i,"Canton"]<-paste(unique(pts[pts$lynx_ID==Opp.table[i,ID],canton]),collapse=", ")
  }
}else{warning("No opp. mon. observations")}

Opp.table$Max.date<-as.character(Opp.table$Max.date)
Opp.table$Min.date<-as.character(Opp.table$Min.date)

#Any lynx not seen in det. mon. but seen in opp. mon:
Opp.table$line<-1:length(Opp.table$ID)
Not.seen<-Opp.table[!grepl(paste(unique(Data[Data$animal_species=="Lynx lynx" & Data$TIME>Start & Data$TIME<Stop,id_individual]), collapse="|"),
      Opp.table$ID),which = FALSE]
Opp.table$line<-NULL


#Change name to fit language
names(Opp.table)<-c("ID","Événement","Date min.","Date max.","Canton")

#Transform data.table into flextable with legend and font
Opp.table<-flextable(Opp.table)
Opp.table<-autofit(Opp.table)
Opp.table <- set_caption(Opp.table, caption = " Observations opportunistes qui ont eu lieu pendant la période du monitoring et qui ont été transmises au KORA. Un événement peut être représenté par plusieurs images prise au même endroit et même moment.")
Opp.table<-font(Opp.table,fontname = "Calibri", part = "all")
Opp.table<-fontsize(Opp.table,size = 12, part = "body")
Opp.table<-height_all(Opp.table, height = .26)
Opp.table<- hrule(Opp.table, rule = "exact")
Opp.table <- bold(Opp.table, bold = TRUE, i=Not.seen[,line])

#Create footnote:
if(length(Not.seen$line)>0){
  Opp.table<- footnote( Opp.table, i = Not.seen[,line],j=1,
            value = as_paragraph("Les lynx observés de manière opportuniste mais pas observés dans le cadre de la session déterministe sont en gras."),ref_symbols = c("1"))
}

if(length(Not.seen$line)==0){
  Opp.table<- footnote( Opp.table, i = 1,j=1,
            value = as_paragraph("Tous les lynx observés de manière opportuniste on également été observés dans le cadre de la session déterministe."),ref_symbols = c("1"),part = "header")
}

```

```{r Plot cumulative, echo=FALSE}

jpeg(filename = "Plot_cumulative.jpeg", width = 16.5, height = 8,
     units = "cm", quality = 100, bg = "white", res=100)

par(mfrow=c(1,2))


par(mar=c(4,3,1,0))
  plot(Occ.table.plot.3$SUM.ID.cumulative, type="o", 
     xlab=NA,ylab=NA,col="blue",
     xaxt='n',las=1,cex.lab=0.8,cex.axis=0.8,pch=19,cex=1.5,lwd=1.5,
     xlim=c(1,20),
     #ylim based on period 5 in case higher:
     ylim=c(0,10^ceiling(log10(max(Occ.table.plot.5$SUM.occasion.cumulative))))) 
  axis(side=1,at=c(1,5,10,15,20),labels = c(1,5,10,15,20),cex.axis=0.8)
  mtext(side=1,"Occasions", line= 2,cex=0.8)
  mtext(side=2,"Captures", line= 2,cex=0.8)
  par(new=TRUE)
  plot(Occ.table.plot.3$SUM.occasion.cumulative, type="o", 
     xlab = NA,ylab=NA,pch=17,
     axes=FALSE,lwd=1.5,cex=1.5,
     xlim=c(1,20),ylim=c(0,10^ceiling(log10(max(Occ.table.plot.5$SUM.occasion.cumulative)))))
  legend("topleft",paste("Closure Test: Otis et al. (1978), p=",round(closure.result.3$Otis$p,3),
"
Occasion = 3 jours
"),cex=0.6)

par(mar=c(4,0.5,1,0.5))
  plot(Occ.table.plot.5$SUM.ID.cumulative, type="o", 
     xlab=NA,ylab="Captures",col="blue",
     xaxt='n',las=1,cex.lab=0.8,cex.axis=0.8,pch=19,cex=1.5,lwd=1.5,
     axes=FALSE,
     xlim=c(1,12),ylim=c(0,10^ceiling(log10(max(Occ.table.plot.5$SUM.occasion.cumulative)))))
  box()
  axis(side=1,at=c(1:12),labels = c(1:12),cex.axis=0.8)
  mtext(side=1,"Occasions", line= 2,cex=0.8)
  par(new=TRUE)
  plot(Occ.table.plot.5$SUM.occasion.cumulative, type="o", 
     xlab = NA,ylab=NA,pch=17,
     axes=FALSE,lwd=1.5,cex=1.5,
     xlim=c(1,12),ylim=c(0,10^ceiling(log10(max(Occ.table.plot.5$SUM.occasion.cumulative)))))
  legend("topleft",paste("Closure Test: Otis et al. (1978), p=",round(closure.result.5$Otis$p,3),
"
Occasion = 5 jours
"),cex=0.6)


invisible(dev.off())


### Select model Plot in Report
Period.selected=5

if(Period.selected==3){
  
  jpeg(filename = "Plot_cumulative_report.jpeg", width = 8, height = 6.1,
     units = "cm", quality = 100, bg = "white", res=100)
  
  par(mar=c(4,3,1,0))
  plot(Occ.table.plot.3$SUM.ID.cumulative, type="o", 
     xlab=NA,ylab=NA,col="blue",
     xaxt='n',las=1,cex.lab=0.8,cex.axis=0.8,pch=19,cex=1.5,lwd=1.5,
     xlim=c(1,20),
     #ylim based on period 5 in case higher:
     ylim=c(0,10^ceiling(log10(max(Occ.table.plot.5$SUM.occasion.cumulative))))) 
  axis(side=1,at=c(1,5,10,15,20),labels = c(1,5,10,15,20),cex.axis=0.8)
  mtext(side=1,"Occasions", line= 2,cex=0.8)
  mtext(side=2,"Captures", line= 2,cex=0.8)
  par(new=TRUE)
  plot(Occ.table.plot.3$SUM.occasion.cumulative, type="o", 
     xlab = NA,ylab=NA,pch=17,
     axes=FALSE,lwd=1.5,cex=1.5,
     xlim=c(1,20),ylim=c(0,10^ceiling(log10(max(Occ.table.plot.5$SUM.occasion.cumulative)))))
  
  invisible(dev.off())
}

if(Period.selected==5){
  
jpeg(filename = "Plot_cumulative_report.jpeg", width = 8, height = 6.1,
     units = "cm", quality = 100, bg = "white", res=100)
par(mar=c(4,0.5,1,0.5))
  plot(Occ.table.plot.5$SUM.ID.cumulative, type="o", 
     xlab=NA,ylab="Captures",col="blue",
     xaxt='n',las=1,cex.lab=0.8,cex.axis=0.8,pch=19,cex=1.5,lwd=1.5,
     axes=FALSE,
     xlim=c(1,12),ylim=c(0,10^ceiling(log10(max(Occ.table.plot.5$SUM.occasion.cumulative)))))
  box()
  axis(side=1,at=c(1:12),labels = c(1:12),cex.axis=0.8)
  mtext(side=1,"Occasions", line= 2,cex=0.8)
  par(new=TRUE)
  plot(Occ.table.plot.5$SUM.occasion.cumulative, type="o", 
     xlab = NA,ylab=NA,pch=17,
     axes=FALSE,lwd=1.5,cex=1.5,
     xlim=c(1,12),ylim=c(0,10^ceiling(log10(max(Occ.table.plot.5$SUM.occasion.cumulative)))))
  
  invisible(dev.off())
}




```

```{r Density comparaison Table, echo= FALSE}

History<-as.matrix(fread("Density_KORA_Historic_Values.csv",header = TRUE))

Komp.DE<-c("Nordostschweiz","Misox (Mesolcina)","Tessin","Surselva","Zentralschweiz Ost","Rhone-Nord","Unterwallisüd","Simme-Saane","Engadin","Jura Nord","Jura Süd","Mittelbünden", "Zentralschweiz West","Zentralschweiz Mitte","Berner Oberland Ost","Oberwallis")

Komp.FR<-c("Nord-Est de la Suisse","Misox (Mesolcina)","Tessin","Surselva","Est de la Suisse centrale","Nord du Rhône","Sud du Bas-Valais", "Simme-Saane", "Engadin", "Nord du Jura","Sud du Jura", "Centre des Grisons","Ouest de la Suisse centrale", "Centre de la Suisse centrale","l'Est de l'Oberland-Bernois","Haute-Valais")

History.comparaison<-data.table(Compartment=Komp.FR)
History.comparaison$COMPID<-c("II","Vb","Va","Vc","IIIc","IVc","IVd","IVa","Ve","Ib","Ia","Vd","IIIa","IIIb","IVb","IVe")

for(i in 1:length(History.comparaison$Compartment)){
  
  list.comp<-tail(as.character(na.omit(History[,i+1])),n=1)
  if(length(list.comp)>0){
  History.comparaison[i,"Winter"]<-History[which(History == list.comp, arr.ind=T)[,"row"],1]
  History.comparaison[i,"Density"]<-as.numeric(substr(list.comp, 1, 4))
  History.comparaison[i,"IC95"]<-paste("(",as.numeric(substr(list.comp, 7, 10)),"-",as.numeric(substr(list.comp, 12, 15)),")",sep="")
  
  }else{History.comparaison[i,"Winter"]<-"Aucun monitoring"}

}

#Set order COMPID (alphabetic order does not work->manual)
History.comparaison<-History.comparaison[c(11,10,1,13,14,5,8,15,6,7,16,3,2,4,12,9),]

#Set name columns (FR/DE)
names(History.comparaison)<-c("Compartiment","ID Comp.","Hiver","Densité","IC 95% ")

#Transform data.table into flextable with legend and font
History.comparaison<-flextable(History.comparaison)
History.comparaison<-autofit(History.comparaison)
History.comparaison <- set_caption(History.comparaison, caption = " Densités estimées de lynx indépendants pour 100 km2 d’habitat favorable des dernières sessions pour les 16 aires de référence officielles. Pour certaines aires de référence, il n'y a jamais eu de monitoring déterministe. Les compartiments sont présentés à la Fig.6.")
History.comparaison<-font(History.comparaison,fontname = "Calibri", part = "all")
History.comparaison<-fontsize(History.comparaison,size = 12, part = "body")
History.comparaison<-height_all(History.comparaison, height = .27)
History.comparaison<- hrule(History.comparaison, rule = "exact")

#Create footnote:
History.comparaison<- footnote( History.comparaison, i = c(10,11),j=5,
            value = as_paragraph("Dans ces compartiments, le nombre de lynx observé était trop faible pour calculer une densité avec un intervalle de confiance."),ref_symbols = c("1"))

```

```{r History + Map Compartment, echo=FALSE}

#History Table

History<-fread("Density_KORA_Historic_Values.csv",header = TRUE,select=c("Year",as.character(Compartment)))

History<-na.omit(History,cols = as.character(Compartment))

for(i in 1:length(History$Year)){
  History[i,"Density"]<-as.numeric(substr(as.character((History[i,2])), 1, 4))
  History[i,"Min95"]<-as.numeric(substr(as.character((History[i,2])), 7, 10))
  History[i,"Max95"]<-as.numeric(substr(as.character((History[i,2])), 12, 15))
}

# Add current Monitoring values to history plot:
History[,2]<-NULL


if(Period.selected==3){
  Current<-data.table(Year=paste(min(year(occasions)),max(year(occasions)),sep="/"),
                    Density=round((Mark.Table$body$dataset[which.best.model.selected,"N"]/favorable)*100,2),
                    Min95=round(((Mark.Table$body$dataset[which.best.model.selected,"N"]-1.96*Mark.Table$body$dataset[which.best.model.selected,"SE"])/favorable)*100,2),
                    Max95=round(((Mark.Table$body$dataset[which.best.model.selected,"N"]+1.96*Mark.Table$body$dataset[which.best.model.selected,"SE"])/favorable)*100,2))
}

if(Period.selected==5){
  Current<-data.table(Year=paste(min(year(occasions)),max(year(occasions)),sep="/"),
                    Density=round((Mark.Table$body$dataset[which.best.model.selected,"N"]/favorable)*100,2),
                    Min95=round(((Mark.Table$body$dataset[which.best.model.selected,"N"]-1.96*Mark.Table$body$dataset[which.best.model.selected,"SE"])/favorable)*100,2),
                    Max95=round(((Mark.Table$body$dataset[which.best.model.selected,"N"]+1.96*Mark.Table$body$dataset[which.best.model.selected,"SE"])/favorable)*100,2))
}

History<-rbind(History,Current)





# Error bar
History.plot<-ggplot2::ggplot(History) +
              ggplot2::geom_bar( ggplot2::aes(x=Year, y=Density), stat="identity",
                                 fill=c(rep("#009E73",length(History$Year)-1),"#E69F00"),
                                 alpha=0.7) +
              ggplot2::geom_errorbar( ggplot2::aes(x=Year, ymin=Min95, ymax=Max95),
                                      width=0.2, colour="black", alpha=0.9, size=1.3)+ggplot2::theme_bw()+
              ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45,hjust = 1),
                             axis.title.x=ggplot2::element_blank())+
              ggplot2::geom_text(ggplot2::aes(y = 0,x=1:length(History$Year)),
                                              label=paste(History$Density," (",History$Min95,"-",History$Max95,")",sep=""),
                                              vjust = 0, nudge_y = .2,size=1)


#Side by side with cummulative plot
  img <- jpeg::readJPEG("Plot_cumulative_report.jpeg")
  g <- grid::rasterGrob(img, interpolate=TRUE)

  Plot.cum<-ggplot2::qplot() +
                  ggplot2::annotation_custom(g, xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)+
                  ggplot2::theme_bw()


  History_denisty_plot<-cowplot::plot_grid(Plot.cum,History.plot,
                   labels=c("A", "B"), label_size = 12,
                   ncol = 2, nrow = 1)



  ggplot2::ggsave("History_denisty_plot.jpeg",plot=History_denisty_plot,
                    units = "cm",
                    width = 16.5,
                    height = 6.1)
```

```{r Plot CH (Introduction), echo=FALSE}

#Import shapefile compartment
Komp <- sf::read_sf(dsn = "MAP_Data/Luchs_Komp_21_07_2015_new.shp")


# -- Altitude layer #
Alt <- raster::raster("MAP_Data/CHHS.TIF")
# indicate CRS
raster::crs(Alt) <- CRS 
# convert to a df for plotting in two steps:
# First, to a SpatialPointsDataFrame
Alt_pts <- raster::rasterToPoints(Alt, spatial = TRUE)

# -- Use ingfo to compute Study Area ####
study_area<-sp::bbox(Alt_pts)
study_area<-rgeos::readWKT(paste("POLYGON((",
                                   study_area[1,1]," ",study_area[2,1],",",
                                   study_area[1,1]," ",study_area[2,2],",",
                                   study_area[1,2]," ",study_area[2,2],",",
                                   study_area[1,2]," ",study_area[2,1],",",
                                   study_area[1,1]," ",study_area[2,1],"))",sep=""),p4s= CRS)

# Then convert SpatialPointsDataFrame to a 'conventional' dataframe
Alt_df  <- data.frame(Alt_pts)
rm(Alt_pts, Alt)

# -- Suitable habitat layer #
suppressWarnings(Suitable <- raster::raster("MAP_Data/suitable_CH1.tif"))
# indicate CRS
raster::crs(Suitable) <- CRS 
# crop 
Suitable<-raster::crop(Suitable,study_area)
# convert to a df for plotting in two steps:
# First, to a SpatialPointsDataFrame
Suitable_pts <- raster::rasterToPoints(Suitable, spatial = TRUE)
# Then to a 'conventional' dataframe
Suitable_df  <- data.frame(Suitable_pts)
rm(Suitable_pts, Suitable)
  
# -- Import shapefile lakes
suppressWarnings(Lakes <- raster::shapefile("MAP_Data/grandlacs.shp"))
Lakes<-raster::crop(Lakes,study_area)
Lakes<-sf::st_as_sf(Lakes)

# --- Import shapefile Study area Polygon
suppressWarnings(Rcompartment <- raster::shapefile("MAP_Data/Reference_areas_alln.shp"))
Rcompartment<-sf::st_as_sf(Rcompartment)
  
map<-ggplot2::ggplot() +
  #Alt Raster
  ggplot2::geom_raster(data = Alt_df , ggplot2::aes(x = x, y = y, alpha = CHHS))+ 
  ggplot2::scale_alpha(name = "", range = c(0.6, 0))+
  #Suitable Raster
  ggplot2::geom_tile(data = Suitable_df , ggplot2::aes(x = x, y = y),fill="yellowgreen", alpha = 0.4)+
  #Polygon Compartment all
  ggplot2::geom_sf(data=Komp$geometry,colour = "black",fill="NA",lwd=1.2)+
  #Polygon Compartment
  ggplot2::geom_sf(data=Komp$geometry[Compartment],fill="white", alpha = 0.4)+
  #Polygon Compartment all text
  ggplot2::geom_sf_text(data=Komp,ggplot2::aes(label =  Nummer))+
  #Lakes
  ggplot2::geom_sf(data=Lakes,fill="#56B4E9")+
  #Reference Area all
  ggplot2::geom_sf(data=Rcompartment,col="#CC79A7",fill=NA,lwd=0.5)+
  #Reference Area all
  ggplot2::geom_sf(data=Rcompartment[Refarea,],col="#009E73",fill=NA,lwd=1.1)


  #Theme
  map<-map+ggplot2::theme(plot.title =ggplot2::element_blank(),
        strip.background = ggplot2::element_blank(),
        panel.background = ggplot2::element_blank(),
        panel.grid = ggplot2::element_blank(),
        axis.title =ggplot2::element_blank(),
        axis.text = ggplot2::element_blank(),
        axis.ticks= ggplot2::element_blank(),
        legend.position="none",
        panel.border = ggplot2::element_rect(colour = "black", fill=NA, size=0.1))+
        ggplot2::scale_x_continuous(expand = c(0, 0)) +
        ggplot2::scale_y_continuous(expand = c(0, 0))
  

  
  # --- Add KORA GIS Logo:
  img <- png::readPNG("KORAlogo.png")#KoraGis_transp
  g <- grid::rasterGrob(img, interpolate=TRUE)
  
  map<-map+
  ggplot2::annotation_custom(g, xmin=study_area[1]@bbox[1,2]-40000, xmax=study_area[1]@bbox[1,2],
                               ymin=study_area[1]@bbox[2,1], ymax=study_area[1]@bbox[2,1]+40000)
  
  
  ggplot2::ggsave("Plot_Introduction_Compartment.jpeg",plot=map,
                    units = "cm",
                    width = 16.5,
                    height = 12)
  



```

```{r Plot reference Area (Introduction), echo=FALSE}

#Import shapefile compartment
Komp <- sf::read_sf(dsn = "MAP_Data/Luchs_Komp_21_07_2015_new.shp")
  
# -- Study Area ####
study_area<-sp::bbox(as.matrix(Komp$geometry[Compartment][[1]]))
study_area.origin<-sp::bbox(as.matrix(Komp$geometry[Compartment][[1]]))
#Add x% around the BBox to have some extra map area
  
  study_area[1,1]<-study_area[1,1]-round(study_area[1,1]*0.02) #x min
  study_area[2,1]<-study_area[2,1]-round(study_area[2,1]*6*0.02) #y min
  study_area[1,2]<-study_area[1,2]+round(study_area[1,2]*0.02) #x max
  study_area[2,2]<-study_area[2,2]+round(study_area[2,2]*0.02) #y max
  
study_area<-rgeos::readWKT(paste("POLYGON((",
                                   study_area[1,1]," ",study_area[2,1],",",
                                   study_area[1,1]," ",study_area[2,2],",",
                                   study_area[1,2]," ",study_area[2,2],",",
                                   study_area[1,2]," ",study_area[2,1],",",
                                   study_area[1,1]," ",study_area[2,1],"))",sep=""),p4s= CRS)
    
# -- Suitable habitat layer #
suppressWarnings(Suitable <- raster::raster("MAP_Data/suitable_CH1.tif"))
# indicate CRS
raster::crs(Suitable) <- CRS 
# crop 
Suitable<-raster::crop(Suitable,study_area)
# convert to a df for plotting in two steps:
# First, to a SpatialPointsDataFrame
Suitable_pts <- raster::rasterToPoints(Suitable, spatial = TRUE)
# Then to a 'conventional' dataframe
Suitable_df  <- data.frame(Suitable_pts)
rm(Suitable_pts, Suitable)
  

# --- Import shapefile Study area Polygon
suppressWarnings(Rcompartment <- raster::shapefile("MAP_Data/Reference_areas_alln.shp"))
Rcompartment<-Rcompartment[Refarea,]

#Import shapefile compartment
suppressWarnings(Komp <- raster::shapefile("MAP_Data/Luchs_Komp_21_07_2015_new.shp"))
Komp<-Komp[Compartment,]

# ------ Open Source Map#### !!! Study area comes fromr Plot CH (Introduction)
  
#study area BBox in lat long
study_area_lat_long <- sp::spTransform(study_area, sp::CRS("+init=epsg:4326"))
  
  LAT1 = study_area_lat_long@bbox[2,1] ; LAT2 = study_area_lat_long@bbox[2,2]
  LON1 = study_area_lat_long@bbox[1,1] ; LON2 = study_area_lat_long@bbox[1,2]
  
#Get the map
#warnings OK
suppressWarnings(map <- OpenStreetMap::openmap(c(LAT2,LON1), c(LAT1,LON2), zoom = 10, #can be replaced by NULL
                                                 type = c("stamen-terrain")[1],
                                                 mergeTiles = TRUE))
  
#Correct projection
#warnings OK
suppressWarnings(map <- OpenStreetMap::openproj(map, projection = "+init=epsg:21781"))
  
# ------ Build map ####

# --- Open Source Map in ggplot:
map<-OpenStreetMap::autoplot.OpenStreetMap(map)+
ggplot2::theme(axis.title=ggplot2::element_blank(),
                   axis.text=ggplot2::element_blank(),
                   axis.ticks=ggplot2::element_blank(),
                   panel.border = ggplot2::element_rect(colour = "white", fill=NA, size=12))


# --- Add Scale:
  
  # distance on x axes:
  dist.scale<-plyr::round_any(round(((study_area@bbox[1,2]-study_area@bbox[1,1])/1000)/4), 10, f = ceiling)
  
  # scale thickness:
  s.thick<-(0.01*(study_area@bbox[2,2]-study_area@bbox[2,1]))
  
  # scale black rectangle
  xleft<-study_area@bbox[1,1]+((study_area.origin[1,1]-study_area@bbox[1,1])/3)#left
  xright<-xleft+dist.scale*1000#right
  ybottom<-study_area.origin[2,1]-4*s.thick#bottom
  ytop<-study_area.origin[2,1]-3*s.thick#top

  map<-map+
    ggplot2::geom_rect(mapping=ggplot2::aes(xmin=xleft, xmax=xright, ymin=ybottom, ymax=ytop),
                       fill=c("black"),
                       inherit.aes = FALSE)+
    ggplot2::geom_text(x=xright+(2/5)*dist.scale*1000, y=ytop, label=paste(dist.scale,"Km",sep=" "), cex=4, color ="black")

  
# --- Add other layers:

map<-map+
#KOMP
ggplot2::geom_polygon(data = Komp@polygons[[1]], ggplot2::aes(x=long, y=lat,group = group),
                               colour="black", fill="white", alpha=0.4, lwd=1.1)+
#Suitable Raster
ggplot2::geom_tile(data = Suitable_df , ggplot2::aes(x = x, y = y),fill="#D55E00", alpha = 0.4)+
#Refarea
ggplot2::geom_polygon(data = Rcompartment@polygons[[1]], ggplot2::aes(x=long, y=lat),
                               colour="#009E73", fill=NA, alpha=1, lwd=1.1)+
#Points Sites
ggplot2::geom_point(data=Data,ggplot2::aes(x,y), col="white", pch=19,cex=2)+
      ggplot2::geom_point(data=Data,ggplot2::aes(x,y),col="black", pch=1,cex=2)
  

ggplot2::ggsave("Plot_Introduction.jpeg",plot=map,
                    units = "cm",
                    width = 16.5,
                    height = 12)
  

```

<br>

<br>

<br>

<br>

<br>



```{r Title, results = 'asis',echo=FALSE}
cat(paste("#",Title,sep=" "))
```

<br>

```{r Authors, results = 'asis',echo=FALSE}
cat(paste("##",Authors, sep=" "))
```

\newpage

### Abstract

The monitoring of the Eurasian  lynx  (*Lynx lynx*)  using camera traps in the reference area *`r unique(Data$session_ref_area)`* during the winter `r paste(year(min(Data$TIME)), year(max(Data$TIME)),sep='/')` was  carried  out  during 60  nights,  from  `r as.character(as.Date(Start))`  to  `r as.character(as.Date(Stop))`. The camera traps at the `r Sites` locations operated during `r prettyNum(effective.TN, big.mark=",",decimal.mark=".")` of the `r prettyNum(potentially.TN, big.mark=",",decimal.mark=".")` potentially possible capture nights (`r sprintf("%.1f",round((effective.TN*100)/potentially.TN,1))`%). With `r Event[ID=="Total",Event]` events at `r Event[ID=="Total",4]` locations, `r N.ind.lynx` independent lynx were pictured. **In addition, `r N.juv` juvenile(s) of at least `r length(unique(Lynx.Table[Lynx.Table$YOB==juv.year & Lynx.Table$mother!="",mother]))` litter(s) were also observed.** The capture-recapture estimate of abundance (95% confidence interval) under model M~`r substr(Mark.Table.inline[which.best.model.selected,Model], 2, 2)`~ was `r Mark.Table.inline[which.best.model.selected,N]` (`r strsplit(Mark.Table.inline[which.best.model.selected,IC], "-")[[1]][1]` - `r strsplit(Mark.Table.inline[which.best.model.selected,IC], "-")[[1]][2]`) independent lynx, which corresponds to a density of  `r prettyNum(History[length(History$Year),Density],decimal.mark=".")` (`r prettyNum(History[length(History$Year),Min95],decimal.mark=".")` - `r prettyNum(History[length(History$Year),Max95],decimal.mark=".")`) independent lynx per 100 km^2^ of suitable habitat. **The estimated density has not changed significantly from the value estimated in the last session (check Fig. Density).**


### Zusammenfassung

Das  Fotofallen-Monitoring  des  Luchses  (*Lynx lynx*) im  Referenzgebiet *`r unique(Data$session_ref_area)`*  wurde im Winter `r paste(year(min(Data$TIME)), year(max(Data$TIME)),sep='/')`  während  60  Nächten, vom `r as.character(as.Date(Start))` bis `r as.character(as.Date(Stop))` durchgeführt. Die Fotofallen an den `r Sites` Standorten funktionierten während `r prettyNum(effective.TN, big.mark="'",decimal.mark=",")` der potentiell möglichen `r prettyNum(potentially.TN, big.mark="'",decimal.mark=",")` Fangnächte (`r sprintf("%.1f",round((effective.TN*100)/potentially.TN,1))`%). Bei `r Event[ID=="Total",Event]` Ereignissen wurden an `r Event[ID=="Total",4]` Standorten `r N.ind.lynx` selbständige Luchse fotografiert. **Darüber hinaus wurden auch `r N.juv` Jungtier(e) aus mindestens `r length(unique(Lynx.Table[Lynx.Table$YOB==juv.year & Lynx.Table$mother!="",mother]))` Wurf/Würfen beobachtet.** Die Fang-Wiederfang Schätzung der Abundanz (95% Konfidenzintervall) nach dem Model M~`r substr(Mark.Table.inline[which.best.model.selected,Model], 2, 2)`~ ergab `r Mark.Table.inline[which.best.model.selected,N]` (`r strsplit(Mark.Table.inline[which.best.model.selected,IC], "-")[[1]][1]` - `r strsplit(Mark.Table.inline[which.best.model.selected,IC], "-")[[1]][2]`) selbständige Luchse im Referenzgebiet, was einer Dichte von `r prettyNum(History[length(History$Year),Density],decimal.mark=",")` (`r prettyNum(History[length(History$Year),Min95],decimal.mark=",")` - `r prettyNum(History[length(History$Year),Max95],decimal.mark=",")`) selbständigen Luchsen pro 100 km^2^ geeignetem Habitat entspricht. **Die Dichte weicht nicht signifikant vom letzten geschätzten Wert ab (check Fig. Density).**

### Résumé

Le monitoring du lynx (*Lynx lynx*) par piège-photographique dans l'aire de référence *`r unique(Data$session_ref_area)`* pour l’hiver `r paste(year(min(Data$TIME)), year(max(Data$TIME)),sep='/')` a duré 60 nuits du `r as.character(as.Date(Start))` au `r as.character(as.Date(Stop))`. Les pièges-photos placés auprès des `r Sites` sites ont fonctionné pendant `r prettyNum(effective.TN, big.mark="'",decimal.mark=",")` des `r prettyNum(potentially.TN, big.mark="'",decimal.mark=",")` nuits potentielles (`r  sprintf("%.1f",round((effective.TN*100)/potentially.TN,1))`%). Dans l’aire de référence, `r Event[ID=="Total",Event]` évènements auprès de `r Event[ID=="Total",4]` sites correspondant à `r N.ind.lynx` lynx indépendants ont été répertoriés. **De plus, `r N.juv` juvenile(s) d'au moins `r length(unique(Lynx.Table[Lynx.Table$YOB==juv.year & Lynx.Table$mother!="",mother]))` portée(s) ont également été observés.** L’estimation de l’abondance (intervalle de confiance de 95%) par le modèle de capture-recapture M~`r substr(Mark.Table.inline[which.best.model.selected,Model], 2, 2)`~ était de `r Mark.Table.inline[which.best.model.selected,N]` (`r strsplit(Mark.Table.inline[which.best.model.selected,IC], "-")[[1]][1]` - `r strsplit(Mark.Table.inline[which.best.model.selected,IC], "-")[[1]][2]`) lynx indépendants ce qui correspond à une densité de `r prettyNum(History[length(History$Year),Density],decimal.mark=",")` (`r prettyNum(History[length(History$Year),Min95],decimal.mark=",")` - `r prettyNum(History[length(History$Year),Max95],decimal.mark=",")`) lynx indépendants pour 100 km^2^ d’habitat favorables. **La densité estimée n’a pas changé significativement par rapport à la valeur estimée lors de la dernière session (check Fig. Density).** 


\newpage


```{r Introduction FR,echo=FALSE,results='asis',eval=Language=="FR"}
cat("### Introduction \n")

cat("Le monitoring déterministe du lynx par pièges-photos est utilisé en Suisse depuis 1998. Celui-ci consiste à répartir des pièges-photos de manière systématique dans une zone précise et à les laisser en place pendant une période donnée. Une session déterministe est conduite tous les trois à quatre ans par le KORA afin d’estimer la taille et la densité de la population de lynx dans des aires de référence choisies de sorte à ce qu’elles soient représentatives pour les sous-compartiments de gestion donnés  (cliquez Fig. 1 et [ici](https://www.kora.ch/index.php?id=240&L=2) pour plus d'informations). La capture-recapture photographique est aujourd’hui une méthode de monitoring standard pour le suivi des espèces aux mœurs secrètes (voir [ici](https://www.kora.ch/index.php?id=105&L=2) pour plus d'informations).

Ce rapport présente les résultats de la session déterministe dans l'aire de référence",unique(Data$session_ref_area)," pour l’hiver ", paste(year(min(Data$TIME)), year(max(Data$TIME)),sep='/')," et qui a duré 60 nuits du", as.character(as.Date(Start))," au ", as.character(as.Date(Stop)),". Les résultats des session précédentes sont disponibles [dans la bibliothèque en ligne du KORA](https://www.kora.ch/index.php?id=345&L=2).
\n")

cat("![**Fig. 1.** Répartition des 16 sous-compartiments de gestion (noir) ainsi que les aires de références (rose). L'aire de référence de cette session est mis en évidence (vert). L'habitat favorable au lynx est présenté en vert claire.](Plot_Introduction_Compartment.jpeg) 

\n")

```



```{r Mat & Met FR,echo=FALSE,results='asis',eval=Language=="FR"}
cat("### Matériel et Méthode \n")

cat("Au total,",Sites," sites uniques avec ",Sites*2," pièges-photos ont été choisis avec l’aide des surveillants de la faune, les chasseurs et les naturalistes principalement le long de chemins forestier et pédestre.",Text.table[6,names(Text.table)[Refarea+1]],"L’aire de référence présente une superficie de ", round(Refareashp$AREA_1[Refarea]/1000000,0)," km^2^ dont ", favorable," km^2^ d'habitat favorable au lynx (Zimmermann 2004)(Fig.2). L’unité de la taille de la population correspond au nombre de lynx âgés de plus d’un an (lynx indépendants), c’est-à-dire les lynx adultes résidents et les lynx subadultes qui se dispersent. Les lynx juvéniles sont aussi identifiés mais ne sont pris en compte dans l’estimation d’abondance et de densité à cause de leur faible taux de détection et de leur fort taux de disparition (mortalité et dispersion). ")

if(JuvasMother==TRUE){
  cat("**Ils sont toutefois comptabilisés comme une capture de leur mère respective dans l'historique de capture.** 
      
      \n")
}

if(JuvasMother==FALSE){
  cat("**Dans cette session, ils ne sont pas comptabilisés comme une capture de leur mère.** 
      
      \n")
}

cat("![**Fig. 2.** Répartitions des sites (disques blancs) dans le sous-compartiment de gestion (ligne noir) ainsi que l'aire de référence (ligne verte). L'habitat favorable au lynx est présenté en orange.](Plot_Introduction.jpeg)")


```




```{r Introduction DE,echo=FALSE,results='asis',eval=Language=="DE"}
cat("### Introduction \n")

cat("Text German Introduction

\n")

cat("![Abb.1 A: die 16 Unterkompartimenten. B: das Unterkompartiment (hellgrau), das Referenzgebiet (grüne Linie), die Standorte (weiße Punkte) und der geeignete Luchshabitat (grün).](Plot_Introduction.jpeg)")

```

\newpage

```{r Results FR,echo=FALSE,results='asis',eval=Language=="FR"}
cat("### Résultats et Discussion \n")


cat("La durée d’échantillonnage potentielle était de ",prettyNum(potentially.TN, big.mark="'")," nuits de captures. **Le vandalisme, des problèmes techniques, des erreurs de manipulation et la météo** ont ramené l’effort d’échantillonnage à ", prettyNum(effective.TN, big.mark="'")," nuits-pièges effectives, soit ", sprintf("%.1f",round((effective.TN*100)/potentially.TN,1)),"%. **Cette valeur est raisonnable et se trouve dans la fourchette des valeurs qui ont été observées lors des autres monitorings menés par le KORA. En tout, ", N.ind.lynx," lynx indépendants et ", N.juv," juvéniles de ", length(unique(Lynx.Table[Lynx.Table$YOB==juv.year & Lynx.Table$mother!="",mother]))," portées ont été détectés (voir Tableau 1)**. Ces lynx ont été photographiés sur", as.numeric(Event[ID=="Total",4])," des ",Sites," sites (", as.numeric(round((Event[ID=="Total",4]*100)/Sites,2)),"%) monté dans le cadre du monitoring (Fig. 3). **Les sites positifs sont répartis de façon uniforme sur l'ensemble de la zone d'étude. (Describe repartition)** ")

if(length(Not.seen$ID)>0){
cat("Lors de cette session,",
length(Not.seen$ID),
" lynx ",
as.character(paste('(',paste(Not.seen$ID,collapse = ', '),')',sep='')),
"ont été observés dans le cadre du monitoring opportuniste sans avoir été photographié dans le cadre du monitoring déterministe.

\n")
}else{cat("

\n")}

cat("![**Fig. 3.** Distribution spatiale des lynx (Polygone Convexe Minimum + zone tampon). Bleu: mâle (zone tampon de 1,4 km), rose: femelle (1,2 km), noir: sexe inconnu (1 km). Disques blancs avec point noir : sites où au moins une photo de lynx a été prise ; disques blancs avec point rouge : sites où au moins une photo de lynx a été prise mais l'individu n'a pas pu être identifié avec certitude; disques blancs: pas de photo de lynx. ](Map_Report.jpeg)")


```

```{r Results DE,echo=FALSE,results='asis',eval=Language=="DE"}
cat("### Resultate und Diskussion \n")

cat("Text German Result

\n")

cat("![Abb.2 ](Map_Report.jpeg)")
```

\newpage

```{r Call Lynx Table, echo=FALSE}
Event.report
```

\newpage
```{r Call Compartment CH + History plot,echo=FALSE, fig.cap="Fig.5 A: Sous compartiments de gestion pour le suivi du lynx en Suisse basé sur le Plan Lynx de 2016 (OFEV 2016). B: Evolution des densités de lynx par superficie d’habitat favorable."}
knitr::include_graphics("History_denisty_plot.jpeg")
```

```{r Call Density comparaison Table, echo= FALSE}
History.comparaison
```



\newpage

```{r Tail Report FR,echo=FALSE,results='asis',eval=Language=="FR"}
cat("### Remerciements \n")

cat("Nous remercions vivement tous ceux qui d’une manière ou d’une autre nous ont aidés et
soutenus. Nous remercions en particulier : 

\n")

cat("- tous les responsables des institutions cantonales et fédérales notamment", 
    paste(Text.table[2,names(Text.table)[Refarea+1]]),
    paste(Text.table[4,names(Text.table)[Refarea+1]]),"pour leur soutien professionnel.
    
    \n")

cat("- tous les surveillants de  la faune, surveillants auxiliaires de la  faune  et naturalistes qui nous ont  aidé lors du choix  des sites ainsi  que  lors  de  la mise  en place  des pièges-photos, les contrôles et le  démontage,  en particulier :", paste(sort(unique(Data[,site_controller])),collapse="; "),"

\n")

cat("- tous les civilistes, stagiaires et collaborateurs au KORA qui ont participé au projet: XXXXX (remove 'KORA' above).

\n")

cat("### Références 

\n")

  
cat("**Citation proposée:** 
\n")

cat(paste(Authors,", ",data.table::year(Sys.time()),". ",Title," KORA Bericht xx, 12pp. 
\n",sep=""))


cat("**Géodonnées:** 
\n")
  
cat("Toutes les analyses et le traitement des données ont été effectués à l'aide du langage et de l'environnement de programmation statistique R 4.1.0 (R Core Team, 2021). Les données utilisées pour créer le fond de carte ont été extraites de l'Open Street Map (https://www.openstreetmap.org/). 
\n")


```


```{r Tail Report DE,echo=FALSE,results='asis',eval=Language=="DE"}
cat("### Danksagung \n")

cat("Wir danken allen ganz herzlich, die uns in irgendeiner Form unterstützt haben. Besonders danken wir: 
    
\n")

cat("- allen  Verantwortlichen der beteiligten kantonalen  und eidgenössischen  Institutionen, namentlich", 
    paste(Text.table[2,names(Text.table)[Refarea+1]]),
    paste(Text.table[3,names(Text.table)[Refarea+1]]),"für ihre  professionelle  Unterstützung.
    
    \n")

cat("- allen Wildhütern, freiwilligen Jagdaufsehern, Jägern und Naturfreunden, die  uns bei der Wahl der  Standorte,  sowie  bei den Kontrollen und  dem Abbruch der Fotofallen geholfen haben, insbesondere: ", paste(sort(unique(Data[,site_controller])),collapse="; "),"

\n")

cat("- alle Zivi, Praktikanten und KORA-Mitarbeiter, die an dem Projekt teilgenommen haben: XXXXX (remove 'KORA' above).

\n")


cat("### Referenzen 
    
\n")

  
cat("**Vorgeschlagene Zitierung:** 
\n")

cat(paste(Authors,", ",data.table::year(Sys.time()),". ",Title," KORA Bericht xx, 12pp. \n",sep=""))


cat("**Digitale geografische Daten:** 
\n")
  
cat("Alle Datenanalysen und die Datenverarbeitung wurden mit der statistischen Programmiersprache und Umgebung R 4.1.0 (R Core Team, 2021) durchgeführt. Die Daten, die für die Erstellung des Kartenhintergrunds verwendet wurden, stammen aus der Open Street Map (https://www.openstreetmap.org/). 
\n")

```


\newpage


```{r plot_other, echo = FALSE, fig.height=8.5, fig.width=6.5}
#This loops create all the maps for the "Species.Other" ex. c("Canis lupus", "Felis silvestris")

if(length(Species.other)>0){
  for(i in 1:length(Species.other)){
   Plot_KORA_Report(Species.other[i])
  }
}
```



\newpage

##### KORA Appendix

###### This part should be removed from the report. It is produced for KORA people writing the report. When finishing the report, one should 1) adapt the number of pages in the citation, 2) adapt the XX of the KORA Bericht xx

![Fig. A.1 Le monitoring opportuniste représente ici les observations opportunistes qui ont eu lieu pendant la période du monitoring et qui ont été transmises au KORA. Seules les observations faites dans l'aire d'étude sont selectionnées. La ligne verte délimite l'aire d'étude. En couleur: secteurs d’activités des lynx (Polygone Convexe Minimum + zone tampon de 2 km); points orange: observation de lynx non-identifiable (U).](Plot_Opp_Mon.jpeg)


\newpage

```{r Call Mark.Table, echo=FALSE}
Mark.Table
```

```{r Call table Opp. mon,echo=FALSE}

Opp.table

```

![Fig. A.2 Cumulative number of occasion (black) and cummulative number of lynx ID (blue). Left = 20 occasions, right = 12 occasions. Closure test should be > 0.05 if the population is closed. The blue line should flatten itself. This shows that we captured most of the lynx ID in the area. The black line should grow constantly. This shows that lynx do not avoid camera traps after their first capture.](Plot_cumulative.jpeg)

\newpage

```{r Call Table.Sites. mon,echo=FALSE}

Table.Sites

```


